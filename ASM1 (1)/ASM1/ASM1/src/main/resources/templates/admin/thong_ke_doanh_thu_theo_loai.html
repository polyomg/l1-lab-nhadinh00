<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>üå∏ Th·ªëng k√™ doanh thu theo lo·∫°i s·∫£n ph·∫©m üå∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #fdeef4, #fff);
            color: #333;
            margin: 0;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #ff69b4;
            font-size: 36px;
            margin-bottom: 40px;
        }

        form {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ffe0ec;
            border-radius: 15px;
            padding: 25px;
            margin: 0 auto 40px auto;
            max-width: 700px;
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.25);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        label {
            font-weight: 600;
            color: #444;
        }

        input[type="date"] {
            padding: 10px 15px;
            border: 1.5px solid #ffd1dc;
            border-radius: 10px;
            font-size: 16px;
            transition: 0.2s;
            outline: none;
        }

        input[type="date"]:focus {
            border-color: #ff69b4;
            box-shadow: 0 0 6px rgba(255, 105, 180, 0.4);
        }

        button {
            background-color: #ff9ecd;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: 0.3s;
        }

        button:hover {
            background-color: #ff6fa9;
        }

        .total-revenue {
            text-align: center;
            font-size: 1.6em;
            color: #ff69b4;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .chart-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 4%;
            margin-bottom: 40px;
        }

        .chart-container .chart, .line-chart {
            flex: 1;
            min-width: 45%;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 6px 25px rgba(255, 182, 193, 0.3);
        }

        .chart h2, .line-chart h2 {
            text-align: center;
            color: #ff69b4;
            margin-bottom: 20px;
            font-size: 22px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(255, 192, 203, 0.25);
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
        }

        th {
            background-color: #ffb6c1;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #fff5f8;
        }

        tr:hover {
            background-color: #ffe6ef;
        }

        h2 {
            text-align: center;
            color: #ff69b4;
            margin: 30px 0 20px 0;
        }

        @media (max-width: 900px) {
            .chart-container {
                flex-direction: column;
                align-items: center;
            }
            .chart-container .chart, .line-chart {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>üå∏ Th·ªëng k√™ doanh thu theo lo·∫°i s·∫£n ph·∫©m üå∏</h1>

    <form action="/thongke-loai" method="get">
        <label for="startDate">T·ª´ ng√†y:</label>
        <input type="date" id="startDate" name="startDate" required>
        <label for="endDate">ƒê·∫øn ng√†y:</label>
        <input type="date" id="endDate" name="endDate" required>
        <button type="submit">üìä Th·ªëng k√™</button>
    </form>

    <div th:if="${doanhThuTheoLoai != null}">
        <div class="total-revenue">
            T·ªïng doanh thu: <span th:text="${#numbers.formatDecimal(tongDoanhThu, 0, 'COMMA', 0, 'POINT')}"></span> VNƒê
        </div>

        <div class="chart-container">
            <div class="chart">
                <h2>üíñ Bi·ªÉu ƒë·ªì tr√≤n doanh thu theo lo·∫°i</h2>
                <canvas id="doanhThuTheoLoaiPieChart"></canvas>
            </div>
            <div class="chart">
                <h2>üì¶ Bi·ªÉu ƒë·ªì c·ªôt doanh thu theo lo·∫°i</h2>
                <canvas id="doanhThuTheoLoaiBarChart"></canvas>
            </div>
        </div>

        <div class="line-chart">
            <h2>üìà Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng doanh thu theo lo·∫°i</h2>
            <canvas id="doanhThuTheoLoaiLineChart"></canvas>
        </div>

        <h2>üìã B·∫£ng t·ªïng k·∫øt doanh thu</h2>
        <table>
            <thead>
                <tr>
                    <th>T√™n lo·∫°i s·∫£n ph·∫©m</th>
                    <th>Doanh thu</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="entry : ${doanhThuTheoLoai}">
                    <td th:text="${entry.key}"></td>
                    <td th:text="${#numbers.formatDecimal(entry.value, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var doanhThuTheoLoai = /*[[${doanhThuTheoLoai}]]*/ {};

        const COLOR_PASTEL = [
            '#ff9ecd', '#ffb6c1', '#ff80b3', '#ff6fa9', '#ffcce0', '#ffa6c9', '#ffd1dc'
        ];

        var labelsLoai = Object.keys(doanhThuTheoLoai);
        var dataLoai = Object.values(doanhThuTheoLoai);
        var colors = labelsLoai.map((_, i) => COLOR_PASTEL[i % COLOR_PASTEL.length]);

        // Bi·ªÉu ƒë·ªì tr√≤n
        new Chart(document.getElementById('doanhThuTheoLoaiPieChart'), {
            type: 'pie',
            data: {
                labels: labelsLoai,
                datasets: [{
                    data: dataLoai,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                                return context.label + ': ' + new Intl.NumberFormat('vi-VN').format(context.parsed) + ' VNƒê (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });

        // Bi·ªÉu ƒë·ªì c·ªôt
        new Chart(document.getElementById('doanhThuTheoLoaiBarChart'), {
            type: 'bar',
            data: {
                labels: labelsLoai,
                datasets: [{
                    data: dataLoai,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNƒê';
                            }
                        }
                    }
                }
            }
        });

        // Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
        new Chart(document.getElementById('doanhThuTheoLoaiLineChart'), {
            type: 'line',
            data: {
                labels: labelsLoai,
                datasets: [{
                    label: 'Doanh thu (VNƒê)',
                    data: dataLoai,
                    borderColor: '#ff69b4',
                    backgroundColor: 'rgba(255, 105, 180, 0.15)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNƒê';
                            }
                        }
                    }
                }
            }
        });
        /*]]>*/
    </script>
</body>
</html>
